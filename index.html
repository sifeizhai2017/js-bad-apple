<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Bad Apple!! - ASCIIè‰ºæœ¯æ’­æ”¾å™¨</title>

  <!-- Bootstrap 5 CSS -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">

  <!-- jQuery -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

  <!-- Bootstrap 5 JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>

  <style>
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    }

    .main-container {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 15px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
    }

    #cv {
      border-radius: 10px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
      max-width: 100%;
      height: auto;
    }

    #txt {
      font-size: 8px;
      line-height: 8px;
      font-family: 'Courier New', Monaco, 'Lucida Console', monospace;
      color: #333;
      background: #f8f9fa;
      border-radius: 10px;
      padding: 15px;
      max-height: 400px;
      overflow-y: auto;
      box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .btn-play {
      background: linear-gradient(45deg, #ff6b6b, #ee5a24);
      border: none;
      border-radius: 50px;
      padding: 12px 30px;
      font-weight: bold;
      color: white;
      transition: all 0.3s ease;
      transform: translateY(0);
      box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
    }

    .btn-play:hover {
      transform: translateY(-2px);
      box-shadow: 0 15px 25px rgba(0, 0, 0, 0.2);
      color: white;
    }

    .btn-play:active {
      transform: translateY(0);
    }

    .progress-container {
      background: rgba(255, 255, 255, 0.8);
      border-radius: 10px;
      padding: 15px;
      margin: 20px 0;
    }

    .ascii-char {
      display: inline;
      white-space: pre;
    }

    .info-card {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
    }

    .feature-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(45deg, #667eea, #764ba2);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 20px;
      margin-bottom: 10px;
    }

    @media (max-width: 768px) {
      #txt {
        font-size: 6px;
        line-height: 6px;
      }
    }
  </style>
</head>

<body>
  <div class="container-fluid py-4">
    <!-- å¤´éƒ¨ä»‹ç» -->
    <div class="row justify-content-center">
      <div class="col-12 col-lg-10">
        <div class="info-card text-center">
          <h1 class="display-4 mb-3">
            <span class="badge bg-dark">Bad Apple!!</span>
            ASCIIè‰ºæœ¯æ’­æ”¾å™¨
          </h1>
          <p class="lead mb-4">
            ä¸‡ç‰©çš†å¯Bad Appleï¼è¿™æ˜¯ä¸€ä¸ªä½¿ç”¨çº¯JavaScriptå®ç°çš„åˆ›æ„é¡¹ç›®ï¼Œ
            å°†ç»å…¸çš„Bad Apple!!MVè½¬æ¢ä¸ºASCIIå­—ç¬¦è‰ºæœ¯åŠ¨ç”»ã€‚
          </p>
          <div class="row text-center">
            <div class="col-md-4">
              <div class="feature-icon mx-auto">ğŸµ</div>
              <h5>éŸ³è§†é¢‘åŒæ­¥</h5>
              <p class="small text-muted">ç²¾ç¡®çš„å¸§åŒæ­¥æŠ€æœ¯</p>
            </div>
            <div class="col-md-4">
              <div class="feature-icon mx-auto">ğŸ¨</div>
              <h5>ç°åº¦è½¬æ¢</h5>
              <p class="small text-muted">æ™ºèƒ½åƒç´ ç°åº¦è®¡ç®—</p>
            </div>
            <div class="col-md-4">
              <div class="feature-icon mx-auto">âš¡</div>
              <h5>å®æ—¶æ¸²æŸ“</h5>
              <p class="small text-muted">Canvas APIé«˜æ•ˆå¤„ç†</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <div class="row justify-content-center">
      <div class="col-12 col-lg-10">
        <div class="main-container p-4">
          <!-- æ§åˆ¶é¢æ¿ -->
          <div class="text-center mb-4">
            <button id="playBtn" class="btn btn-play btn-lg">
              <i id="playIcon">â–¶ï¸</i> <span id="playText">å¼€å§‹æ’­æ”¾</span>
            </button>
          </div>

          <!-- è¿›åº¦æ˜¾ç¤º -->
          <div class="progress-container" id="progressContainer" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <small class="text-muted">æ’­æ”¾è¿›åº¦</small>
              <small class="text-muted" id="progressText">0 / 4380</small>
            </div>
            <div class="progress" style="height: 8px;">
              <div class="progress-bar progress-bar-striped progress-bar-animated" id="progressBar" role="progressbar"
                style="width: 0%"></div>
            </div>
          </div>

          <!-- ç”»å¸ƒå’ŒASCIIæ˜¾ç¤ºåŒºåŸŸ -->
          <div class="row">
            <div class="col-lg-6 mb-4">
              <div class="text-center">
                <h5 class="mb-3">åŸå§‹å¸§ç”»é¢</h5>
                <canvas id="cv" class="img-fluid"></canvas>
              </div>
            </div>
            <div class="col-lg-6 mb-4">
              <div class="text-center">
                <h5 class="mb-3">ASCIIè‰ºæœ¯è½¬æ¢</h5>
                <div id="txt" class="text-start"></div>
              </div>
            </div>
          </div>

          <!-- æŠ€æœ¯è¯´æ˜ -->
          <div class="mt-4">
            <div class="accordion" id="techAccordion">
              <div class="accordion-item">
                <h2 class="accordion-header">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                    data-bs-target="#techDetails">
                    ğŸ”§ æŠ€æœ¯å®ç°åŸç†
                  </button>
                </h2>
                <div id="techDetails" class="accordion-collapse collapse">
                  <div class="accordion-body">
                    <h6>ğŸ¯ æ ¸å¿ƒæŠ€æœ¯æ ˆï¼š</h6>
                    <ul class="mb-3">
                      <li><strong>HTML5 Canvas API</strong> - ç”¨äºå›¾åƒå¤„ç†å’Œåƒç´ æ•°æ®è·å–</li>
                      <li><strong>jQuery</strong> - ç®€åŒ–DOMæ“ä½œå’Œäº‹ä»¶å¤„ç†</li>
                      <li><strong>Bootstrap 5</strong> - å“åº”å¼UIæ¡†æ¶</li>
                      <li><strong>JavaScript</strong> - æ ¸å¿ƒé€»è¾‘å®ç°</li>
                    </ul>

                    <h6>âš™ï¸ å·¥ä½œåŸç†ï¼š</h6>
                    <ol>
                      <li><strong>å›¾åƒåŠ è½½</strong> - é€å¸§åŠ è½½Bad Appleè§†é¢‘å¸§å›¾ç‰‡</li>
                      <li><strong>Canvasæ¸²æŸ“</strong> - å°†å›¾ç‰‡ç»˜åˆ¶åˆ°Canvasç”»å¸ƒä¸Š</li>
                      <li><strong>åƒç´ åˆ†æ</strong> - ä½¿ç”¨getImageData()è·å–åƒç´ RGBAæ•°æ®</li>
                      <li><strong>ç°åº¦è®¡ç®—</strong> - åº”ç”¨å…¬å¼ï¼š0.299*R + 0.578*G + 0.114*B</li>
                      <li><strong>å­—ç¬¦æ˜ å°„</strong> - æ ¹æ®ç°åº¦å€¼æ˜ å°„åˆ°ä¸åŒçš„ASCIIå­—ç¬¦</li>
                      <li><strong>å®šæ—¶æ’­æ”¾</strong> - ä½¿ç”¨setTimeoutå®ç°50msé—´éš”çš„å¸§åŠ¨ç”»</li>
                    </ol>

                    <h6>ğŸ¨ ASCIIå­—ç¬¦é›†ï¼š</h6>
                    <p class="font-monospace small bg-light p-2 rounded">
                      # H Q & O C ? 7 > ! : - ; .
                    </p>
                    <p class="small text-muted">
                      å­—ç¬¦æŒ‰å¯†åº¦ä»é«˜åˆ°ä½æ’åˆ—ï¼Œ#æœ€å¯†é›†ï¼ˆé»‘è‰²åŒºåŸŸï¼‰ï¼Œ.æœ€ç¨€ç–ï¼ˆç™½è‰²åŒºåŸŸï¼‰
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- éŸ³é¢‘å…ƒç´  -->
    <audio id="audio" style="display: none;">
      <source src="./audio/BADAPPLE!!Chi.mp3" type="audio/mpeg">
      æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾ã€‚
    </audio>
  </div>

  <script>
    $(document).ready(function () {
      // å˜é‡å£°æ˜
      let $canvas = $('#cv');
      let canvas = $canvas[0];
      let context = canvas.getContext('2d');
      let $txtDiv = $('#txt');
      let $playBtn = $('#playBtn');
      let $audio = $('#audio');
      let $progressContainer = $('#progressContainer');
      let $progressBar = $('#progressBar');
      let $progressText = $('#progressText');
      let $playIcon = $('#playIcon');
      let $playText = $('#playText');

      let img = new Image();
      let index = 1;
      let isPlaying = false;
      let totalFrames = 4380;
      let playInterval;

      // æ’­æ”¾æŒ‰é’®ç‚¹å‡»äº‹ä»¶
      $playBtn.on('click', function () {
        if (!isPlaying) {
          startPlay();
        } else {
          stopPlay();
        }
      });

      // å¼€å§‹æ’­æ”¾
      function startPlay() {
        isPlaying = true;
        $playIcon.text('â¸ï¸');
        $playText.text('æ’­æ”¾ä¸­...');
        $playBtn.removeClass('btn-play').addClass('btn-warning');
        $progressContainer.show();

        playImg();
        $audio[0].play().catch(e => {
          console.log('éŸ³é¢‘æ’­æ”¾å¤±è´¥:', e);
        });
      }

      // åœæ­¢æ’­æ”¾
      function stopPlay() {
        isPlaying = false;
        $playIcon.text('â–¶ï¸');
        $playText.text('å¼€å§‹æ’­æ”¾');
        $playBtn.removeClass('btn-warning').addClass('btn-play');

        if (playInterval) {
          clearTimeout(playInterval);
        }

        $audio[0].pause();
        resetPlayer();
      }

      // é‡ç½®æ’­æ”¾å™¨
      function resetPlayer() {
        index = 1;
        $audio[0].load();
        img.src = './img/badapple00001.jpg';
        updateProgress();
      }

      // æ’­æ”¾å›¾ç‰‡åºåˆ—
      function playImg() {
        if (index <= totalFrames && isPlaying) {
          img.src = './img/badapple' + formatIndex(index) + '.jpg';
          updateProgress();
          index++;
          playInterval = setTimeout(playImg, 50); // 20fps
        } else if (index > totalFrames) {
          // æ’­æ”¾å®Œæˆ
          $playIcon.text('âœ…');
          $playText.text('æ’­æ”¾å®Œæˆ');
          $playBtn.removeClass('btn-warning').addClass('btn-success');
          isPlaying = false;

          // 3ç§’åé‡ç½®
          setTimeout(() => {
            resetPlayer();
            $playIcon.text('â–¶ï¸');
            $playText.text('é‡æ–°æ’­æ”¾');
            $playBtn.removeClass('btn-success').addClass('btn-play');
            $progressContainer.hide();
          }, 3000);
        }
      }

      // æ›´æ–°è¿›åº¦æ¡
      function updateProgress() {
        let progress = ((index - 1) / totalFrames) * 100;
        $progressBar.css('width', progress + '%');
        $progressText.text((index - 1) + ' / ' + totalFrames);
      }

      // æ ¼å¼åŒ–ç´¢å¼•ä¸º4ä½æ•°å­—ç¬¦ä¸²
      function formatIndex(index) {
        return index.toString().padStart(5, '0');
      }

      // æ ¹æ®ç°åº¦å€¼è½¬æ¢ä¸ºASCIIå­—ç¬¦
      function toText(gray) {
        const chars = '#HQ&OC?7>!:-;.';
        const step = 255 / chars.length;
        const charIndex = Math.floor(gray / step);
        return chars[Math.min(charIndex, chars.length - 1)];
      }

      // è®¡ç®—RGBçš„ç°åº¦å€¼
      function getGray(r, g, b) {
        return 0.299 * r + 0.578 * g + 0.114 * b;
      }

      // åˆå§‹åŒ–å‡½æ•° - å°†å›¾åƒè½¬æ¢ä¸ºASCII
      function init() {
        // è®¾ç½®ç”»å¸ƒå°ºå¯¸
        canvas.width = img.width;
        canvas.height = img.height;
        $txtDiv.css('width', img.width + 'px');

        // ç»˜åˆ¶å›¾åƒåˆ°ç”»å¸ƒ
        context.drawImage(img, 0, 0);

        // è·å–å›¾åƒæ•°æ®
        let imgData = context.getImageData(0, 0, img.width, img.height);
        let data = imgData.data;
        let width = imgData.width;
        let height = imgData.height;

        // è½¬æ¢ä¸ºASCIIå­—ç¬¦
        let html = '';
        const stepX = 6; // æ°´å¹³é‡‡æ ·é—´éš”
        const stepY = 12; // å‚ç›´é‡‡æ ·é—´éš”

        for (let y = 0; y < height; y += stepY) {
          let line = '';
          for (let x = 0; x < width; x += stepX) {
            let pixelIndex = (y * width + x) * 4;
            let r = data[pixelIndex];
            let g = data[pixelIndex + 1];
            let b = data[pixelIndex + 2];
            let gray = getGray(r, g, b);
            line += toText(gray);
          }
          html += '<div class="ascii-line">' + line + '</div>';
        }

        $txtDiv.html(html);
      }

      // å›¾ç‰‡åŠ è½½å®Œæˆäº‹ä»¶
      img.onload = init;

      // åˆå§‹åŒ–ç¬¬ä¸€å¸§
      img.src = './img/badapple00001.jpg';

      // é”™è¯¯å¤„ç†
      img.onerror = function () {
        $txtDiv.html('<div class="alert alert-warning">å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥å›¾ç‰‡è·¯å¾„æ˜¯å¦æ­£ç¡®</div>');
      };
    });
  </script>
</body>

</html>